# 卓越软件开发基础Project说明文档
——19302010009钱麒丹

## 一、项目概述
在本次卓越软件开发基础的Project中，通过对前后端的独立开发。我基本实现了项目中的基本功能，并适当完成了部分Bonus任务。在技术实现上，我选择 **Tomcat** 作为容器，在前端页面的构建中使用到了 **Bootstrap** 框架，在后端则使用了 **JSP+Servlet+JavaBean** 的MVC架构来实现，具体代码编写过程中还使用到了如用于压缩图片的Thumbnailator这般的 **类库** 。

项目服务器部署地址: http://cymqqdwebfundamental.ink:8080/project/  
项目GitHub地址: https://github.com/HakureiReimuOVO/WebProject-2020-7/

## 二、项目结构
/Vacation  
............/out 项目编译完毕的输出目录  
............/src 存放项目中使用的Java类  
......................../bean **MODEL** 存放JavaBean  
......................../DAO 存放访问数据库的DAO  
......................../servlet **CONTROLLER** 存放各类Servlet  
..................................../service 存放响应页面请求的Servlet  
..................................../viewer 存放实现主页面跳转解析的Servlet  
......................../utils 存放项目中的实用类  
............/web  
......................../ajax 存放响应Ajax请求的JSP页面  
......................../pages **VIEW** 存放项目中的JSP主页面  
......................../src 存放项目中使用到的资源  
..................................../bootstrap-4.5.0-dist 存放Bootstrap框架  
..................................../jquery-3.5.1 存放JQuery  
..................................../CSS 存放各主页面的CSS  
..................................../JavaScript 存放JavaScript  
..................................../images  
................................................/html-images 存放html页面中使用到的图片  
................................................/travel-images 存放用户上传的图片  
............................................................/large 大尺寸  
............................................................/medium 中尺寸  
............................................................/small 小尺寸  
......................../WEB-INF  
..................................../classes 存放编译完毕的Java类  
..................................../lib 存放项目中使用的Jar包  
..................................../web.xml 项目的配置文件  
............/travels.sql 项目的原始数据库文件  

### Java类
/src  
............/bean **(1)**  
............/DAO **(2)**  
............/servlet  
......................../service **(3)**  
......................../viewer **(4)**  
............/utils **(5)**  

**（1）bean**  
bean包中存放了项目中使用到的JavaBean，用于封装项目中使用到的重要对象。我在项目中构建并使用到了User、Photo和Message三个bean。其中User对象用于封装数据库中与用户相关的所有信息；Photo对象用于封装与用户上传照片相关的所有信息；Message用于封装用户发送的实时消息的所有信息。构建此类JavaBean可以使得在Controller向页面传递信息以及页面调用相关信息时，代码更加清晰可读且实用。

**（2）DAO**  
DAO包中存放了项目中使用到的DAO，用于简化数据访问的流程。我在其中构建了DAO、UserDAO、PhotoDAO和MessageDAO四个Java类。DAO类是其余三个类的父类，其通过DBCP连接池获得数据库连接，可以使用通过DAO类中的方法来更新数据库，查询数据库并返回相应的结果集Map、List<Map>等等。而其余三个类则是用于读取指定数据的DAO类，例如UserDAO返回的结果集为User或List<User>类型，这样可以极大程度上方便对数据库数据的读取。

**（3）service**  
service包中存放了项目中负责 **响应页面请求** 的Servlet。例如FavorServlet用于响应收藏和取消收藏图片的请求，LoginServlet用于响应登录请求等等。其作为页面和数据库进行数据交互的中介，分析处理页面请求中数据，并调用数据库返回数据对应的结果。

**（4）viewer**  
viewer包中存放了项目中负责 **页面跳转** 的Servlet。例如其中的Index在用户访问/index时被调用，其通过与数据库的交互获得PopularPhotos以及NewPhotos，并将其作为参数发送至index.jsp，最终使index.jsp完成数据的呈现。其作为页面初始化调用数据时必要的Servlet。

**（5）utils**  
utils包中存放了项目中常用的实用方法。例如根据CityCode或CountryCode查询对应的CityName和CountryName，以及根据ImageID获得Favor数量等等。使得编写过程不必写重复且冗长的功能代码，增加了代码的可复用性。

### JSP文件
/pages  
............/chat.jsp  
............/datails.jsp  
............/favor.jsp  
............/friend.jsp  
............/index.jsp  
............/login.jsp  
............/photo.jsp  
............/register.jsp  
............/search.jsp  
............/upload.jsp  
............/welcome.jsp  

项目中共10个主要页面，分别有与之相对应的JSP文件。有一个特殊的JSP文件为welcome.jsp，其用于访问项目根目录时，跳转至/index路径下。这么做是因为在Tomcat的首页配置中，只能够选择具体的JSP页面作为首页，因此我选择将welcome.jsp作为首页，并进行相应跳转，以导航至正确的首页位置。

### Ajax实现
/ajax  
............/chatAjax.jsp  
............/favorAjax.jsp  
............/photoAjax.jsp  
............/searchAjax.jsp  

注意到响应Ajax的是JSP文件。在本次PJ项目中，我首先将页面发出Ajax请求后所得到的响应格式确定为文本，并因此使用了 **Page->ServiceServlet->AjaxJSP** 这样的结构。页面首先将Ajax请求发送至ServiceServlet，ServiceServlet即service包中的部分Servlet，其负责读取并处理Ajax请求的参数信息，再将其发送至相应JSP页面。JSP页面负责将相应数据输入进文本中，最后将处理完毕的文本发送回原页面中，至此便完成了项目中Ajax请求的所有步骤。

### 数据库结构
Travels  
|----geocities 存放与CityCode对应的城市信息  
|----geocountries_regions 存放与CountryCode对应的国家信息  
|----travelimage 存放用户上传的图片信息  
|----travelimagefavor 存放用户收藏图片的信息  
|----traveluser 存放用户信息  
|----traveluserfriend 存放用户好友的信息  
|----travelusermessage 存放用户好友间聊天的信息  

## 三、项目功能
### 基本功能实现
项目中的基本功能大体上均可以通过JSP+Servlet+JavaBean的模型实现。此次项目中，各页面的基本功能我均已在以上结构的基础上进行实现，由于功能较多且实现原理多重复，仅选择 **部分功能** 实现作解释。

**（1）表单验证**  
在本项目中，大部分表单信息我都选择在前端使用JS进行验证，包括文件上传和注册登录等等，以减轻服务器压力。但并不包括部分比如说重复用户名以及登录失败，此类必须与服务器进行交互的验证内容。

**（2）Session与Cookie**  
登录状态保持我使用了Session作为实现基础。登录和注册完后跳转至先前页面，我也使用了Session作为实现基础，原理为访问每一个页面过后，都更新一次Session中最后访问页面的相关属性。足迹功能我使用了Cookie作为实现基础，同时在删除和修改图片过后都有必要对Cookie进行更新，因为这两个操作都会改变足迹的原先内容。

**（3）Cookie标题保存**  
在将标题保存至Cookie中时，我选择将标题先URLEncode一次，并在调用时URLDecode一次。原因是Cookie的旧标准中使得不能包括空格引号等的特殊字符，在存储图片标题可能出现报错。

### Bonus实现
Bonus中我基本实现了图片局部放大功能，注册与登录验证码功能，好友用户实时聊天功能以及项目的云部署。

**（1）图片局部放大功能**  
图片局部放大功能的实现基于JS。首先在页面中内置另一张根据比例放大的图片，并进行隐藏。在光标经过图片触发事件时，显示放大的图片，并通过光标当前的坐标相对原图的位置进行计算，对放大的图片进行裁剪以及偏移，进而实现图片局部放大。
 
**（2）注册与登录验证码功能**  
注册与登录验证码功能的实现，关键在于通过Servlet生成一张验证码的图片并将其作为response返回，并在生成的同时，将验证码的文本内容存储至Session中以便之后验证。在前端页面，则需要将验证码图片的src设置为该Servlet的映射路径，以便成功显示验证码图片。在用户注册与登录时，服务器可调用Session中的正确验证码内容进行比对验证。

**（3）好友用户实时聊天功能**  
好友用户实时聊天功能的实现主要基于Ajax，利用对服务器的定时请求实现用户间的聊天，在聊天页面加载完毕、自己的消息发送以及间隔一定时间段后，页面都会再次发送Ajax请求以获取聊天信息。

**（4）项目的云部署**  
我使用了Ubuntu系统的服务器进行了项目的云部署。至于具体实现，首先需要在服务器端进行Tomcat、mysql以及JDK的安装，并配置相关环境。然后将本地的项目打包输出为war文件并上传至服务器端，根据服务器端环境的不同完成最终调试，实现云部署。
